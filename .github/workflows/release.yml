name: Generate CV and Release

on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-core fonts-noto-cjk fonts-noto-cjk-extra
          
          # Download Noto Serif JP (Mincho) from GitHub releases
          mkdir -p ~/.fonts
          curl -L -o /tmp/NotoSerifJP.zip "https://github.com/notofonts/noto-cjk/releases/download/Serif2.003/12_NotoSerifJP.zip"
          unzip -o /tmp/NotoSerifJP.zip -d ~/.fonts/
          fc-cache -fv

      # ===== Standard CV (with frontmatter) =====
      - name: Generate English CV (A4)
        run: npx md2cv -i cv-en/cv-en.md -o cv-en/cv-en -f cv -t both -p a4

      - name: Generate Japanese CV (A4)
        run: npx md2cv -i rirekisho-cv-ja/cv-ja.md -o rirekisho-cv-ja/cv-ja -f cv -t both -p a4

      - name: Generate Japanese Rirekisho (A3)
        run: npx md2cv -i rirekisho-cv-ja/cv-ja.md -o rirekisho-cv-ja/cv-ja -f rirekisho -t both -p a3 --photo rirekisho-cv-ja/sample-photo.png

      # ===== Environment Variables CV =====
      - name: Generate English CV from env variables (A4)
        env:
          NAME: ${{ secrets.CV_EN_NAME }}
          EMAIL_ADDRESS: ${{ secrets.CV_EN_EMAIL_ADDRESS }}
          PHONE_NUMBER: ${{ secrets.CV_EN_PHONE_NUMBER }}
          HOME_ADDRESS: ${{ secrets.CV_EN_HOME_ADDRESS }}
          LINKEDIN: ${{ secrets.CV_EN_LINKEDIN }}
        run: npx md2cv -i cv-en-env-variables/cv-en.md -o cv-en-env-variables/cv-en-env -f cv -t both -p a4

      - name: Generate Japanese CV from env variables (A4)
        env:
          NAME: ${{ secrets.CV_JA_NAME }}
          NAME_JA: ${{ secrets.CV_JA_NAME_JA }}
          NAME_FURIGANA: ${{ secrets.CV_JA_NAME_FURIGANA }}
          EMAIL_ADDRESS: ${{ secrets.CV_JA_EMAIL_ADDRESS }}
          PHONE_NUMBER: ${{ secrets.CV_JA_PHONE_NUMBER }}
          POST_CODE: ${{ secrets.CV_JA_POST_CODE }}
          HOME_ADDRESS: ${{ secrets.CV_JA_HOME_ADDRESS }}
          HOME_ADDRESS_FURIGANA: ${{ secrets.CV_JA_HOME_ADDRESS_FURIGANA }}
          EMAIL_ADDRESS2: ${{ secrets.CV_JA_EMAIL_ADDRESS2 }}
          PHONE_NUMBER2: ${{ secrets.CV_JA_PHONE_NUMBER2 }}
          POST_CODE2: ${{ secrets.CV_JA_POST_CODE2 }}
          HOME_ADDRESS2: ${{ secrets.CV_JA_HOME_ADDRESS2 }}
          HOME_ADDRESS2_FURIGANA: ${{ secrets.CV_JA_HOME_ADDRESS2_FURIGANA }}
          DOB: ${{ secrets.CV_JA_DOB }}
          GENDER: ${{ secrets.CV_JA_GENDER }}
        run: npx md2cv -i cv-ja-env-variables/cv-ja.md -o cv-ja-env-variables/cv-ja-env -f cv -t both -p a4

      - name: Generate Japanese Rirekisho from env variables (A3)
        env:
          NAME: ${{ secrets.CV_JA_NAME }}
          NAME_JA: ${{ secrets.CV_JA_NAME_JA }}
          NAME_FURIGANA: ${{ secrets.CV_JA_NAME_FURIGANA }}
          EMAIL_ADDRESS: ${{ secrets.CV_JA_EMAIL_ADDRESS }}
          PHONE_NUMBER: ${{ secrets.CV_JA_PHONE_NUMBER }}
          POST_CODE: ${{ secrets.CV_JA_POST_CODE }}
          HOME_ADDRESS: ${{ secrets.CV_JA_HOME_ADDRESS }}
          HOME_ADDRESS_FURIGANA: ${{ secrets.CV_JA_HOME_ADDRESS_FURIGANA }}
          EMAIL_ADDRESS2: ${{ secrets.CV_JA_EMAIL_ADDRESS2 }}
          PHONE_NUMBER2: ${{ secrets.CV_JA_PHONE_NUMBER2 }}
          POST_CODE2: ${{ secrets.CV_JA_POST_CODE2 }}
          HOME_ADDRESS2: ${{ secrets.CV_JA_HOME_ADDRESS2 }}
          HOME_ADDRESS2_FURIGANA: ${{ secrets.CV_JA_HOME_ADDRESS2_FURIGANA }}
          DOB: ${{ secrets.CV_JA_DOB }}
          GENDER: ${{ secrets.CV_JA_GENDER }}
        run: npx md2cv -i cv-ja-env-variables/cv-ja.md -o cv-ja-env-variables/cv-ja-env -f rirekisho -t both -p a3 --photo cv-ja-env-variables/sample-photo.png

      - name: Get current date
        id: date
        run: echo "tag=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.date.outputs.tag }}
          name: Release ${{ steps.date.outputs.tag }}
          files: |
            cv-en/cv-en_cv.pdf
            cv-en/cv-en_cv.html
            rirekisho-cv-ja/cv-ja_cv.pdf
            rirekisho-cv-ja/cv-ja_cv.html
            rirekisho-cv-ja/cv-ja_rirekisho.pdf
            rirekisho-cv-ja/cv-ja_rirekisho.html
            cv-en-env-variables/cv-en-env_cv.pdf
            cv-en-env-variables/cv-en-env_cv.html
            cv-ja-env-variables/cv-ja-env_cv.pdf
            cv-ja-env-variables/cv-ja-env_cv.html
            cv-ja-env-variables/cv-ja-env_rirekisho.pdf
            cv-ja-env-variables/cv-ja-env_rirekisho.html
          generate_release_notes: true
